name: Deploy Cachao

on:
  push:
    branches:
      - main        # Deploy to production
      - staging     # Deploy to staging
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

env:
  AWS_REGION: eu-west-1
  SAM_CLI_TELEMETRY: 0

jobs:
  # ============================================
  # Backend Deployment (AWS SAM)
  # ============================================
  deploy-backend:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/events-function/package-lock.json

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "stack_name=Cachao-prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "stack_name=Cachao-staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "stack_name=Cachao" >> $GITHUB_OUTPUT
          fi

      - name: SAM Build
        working-directory: backend
        run: sam build

      - name: SAM Deploy - Production
        if: github.ref == 'refs/heads/main'
        working-directory: backend
        run: |
          sam deploy \
            --stack-name ${{ steps.env.outputs.stack_name }} \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=prod \
              DatabaseHost=${{ secrets.PROD_DB_HOST }} \
              DatabaseUser=${{ secrets.PROD_DB_USER }} \
              DatabasePassword=${{ secrets.PROD_DB_PASSWORD }} \
              StripeSecretKey=${{ secrets.PROD_STRIPE_SECRET_KEY }} \
              StripeWebhookSecret=${{ secrets.PROD_STRIPE_WEBHOOK_SECRET }} \
              AviationStackApiKey=${{ secrets.AVIATIONSTACK_API_KEY }} \
              AirLabsApiKey=${{ secrets.AIRLABS_API_KEY }} \
              StripePartnerEventBusName=${{ secrets.PROD_STRIPE_PARTNER_BUS }}

      - name: SAM Deploy - Staging
        if: github.ref == 'refs/heads/staging'
        working-directory: backend
        run: |
          sam deploy \
            --stack-name ${{ steps.env.outputs.stack_name }} \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=staging \
              DatabaseHost=${{ secrets.STAGING_DB_HOST }} \
              DatabaseUser=${{ secrets.STAGING_DB_USER }} \
              DatabasePassword=${{ secrets.STAGING_DB_PASSWORD }} \
              StripeSecretKey=${{ secrets.STAGING_STRIPE_SECRET_KEY }} \
              StripeWebhookSecret=${{ secrets.STAGING_STRIPE_WEBHOOK_SECRET }} \
              AviationStackApiKey=${{ secrets.AVIATIONSTACK_API_KEY }} \
              AirLabsApiKey=${{ secrets.AIRLABS_API_KEY }}

      - name: Get Stack Outputs
        id: stack-outputs
        working-directory: backend
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ steps.env.outputs.stack_name }} \
            --query "Stacks[0].Outputs[?OutputKey=='CachaoApi'].OutputValue" \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ steps.env.outputs.stack_name }} \
            --query "Stacks[0].Outputs[?OutputKey=='UserPoolId'].OutputValue" \
            --output text)
          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
          
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ steps.env.outputs.stack_name }} \
            --query "Stacks[0].Outputs[?OutputKey=='UserPoolClientId'].OutputValue" \
            --output text)
          echo "user_pool_client_id=$USER_POOL_CLIENT_ID" >> $GITHUB_OUTPUT

    outputs:
      api_url: ${{ steps.stack-outputs.outputs.api_url }}
      user_pool_id: ${{ steps.stack-outputs.outputs.user_pool_id }}
      user_pool_client_id: ${{ steps.stack-outputs.outputs.user_pool_client_id }}
      environment: ${{ steps.env.outputs.environment }}

  # ============================================
  # Backend Tests (on PR)
  # ============================================
  test-backend:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: backend/events-function
        run: npm ci

      - name: Run tests
        working-directory: backend/events-function
        run: npm test || echo "No tests configured yet"

      - name: SAM Validate
        working-directory: backend
        run: |
          pip install aws-sam-cli
          sam validate --lint

  # ============================================
  # Frontend Tests (on PR)
  # ============================================
  test-frontend:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build check
        working-directory: frontend
        run: npm run build
        env:
          NUXT_PUBLIC_API_URL: https://example.com
          NUXT_PUBLIC_COGNITO_USER_POOL_ID: test-pool
          NUXT_PUBLIC_COGNITO_CLIENT_ID: test-client

  # ============================================
  # Notify on Success
  # ============================================
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: success() && github.event_name == 'push'
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.deploy-backend.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ needs.deploy-backend.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**User Pool ID:** ${{ needs.deploy-backend.outputs.user_pool_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**User Pool Client ID:** ${{ needs.deploy-backend.outputs.user_pool_client_id }}" >> $GITHUB_STEP_SUMMARY

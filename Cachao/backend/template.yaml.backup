AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Cachao

  Sample SAM Template for Cachao
  
Globals:
  Function:
    Timeout: 60

Resources:
  CachaoApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      BinaryMediaTypes:
        - multipart/form-data
        - '*/*'
      MinimumCompressionSize: 0
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS,PATCH'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept,Origin,X-Requested-With'"
        AllowOrigin: "'*'"
        MaxAge: "'86400'"
        AllowCredentials: false
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt CachaoUserPool.Arn

  CachaoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-user-pool'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: false
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      MfaConfiguration: "OFF"

  CachaoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CachaoUserPool
      ClientName: !Sub '${AWS::StackName}-client'
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED

  CachaoVideosBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'cachao-videos-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - POST
              - HEAD
            AllowedOrigins:
              - "*"
            ExposedHeaders:
              - ETag
              - x-amz-server-side-encryption
              - x-amz-request-id
              - x-amz-id-2
            MaxAge: 3000

  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - app.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: hello-world/
      Handler: app.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Events:
        HelloWorld:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /hello
            Method: get

  MigrateAddImageUrlFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-image-url.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-image-url/
      Handler: migrate-add-image-url.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddImageUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /migrate/add-image-url
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddAlbumsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-albums.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-albums/
      Handler: migrate-add-albums.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddAlbums:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /admin/migrate-add-albums
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddDateToAlbumsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-date-to-albums.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-date-to-albums/
      Handler: migrate-add-date-to-albums.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddDateToAlbums:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /admin/migrate-add-date-to-albums
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddEventStaffFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-event-staff.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-event-staff/
      Handler: migrate-add-event-staff.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddEventStaff:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /admin/migrate/add-event-staff
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddFlightsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-flights.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-flights/
      Handler: migrate-add-flights.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddFlights:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /admin/migrate-add-flights
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddUsersFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-users.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-users/
      Handler: migrate-add-users.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddUsers:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /migrate/add-users
            Method: post
            Auth:
              Authorizer: NONE

  MigrateAddThumbnailFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - migrate-add-thumbnail.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: migrate-add-thumbnail/
      Handler: migrate-add-thumbnail.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        MigrateAddThumbnail:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /migrate/add-thumbnail
            Method: post
            Auth:
              Authorizer: NONE

  CreateUserFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - create-user.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: create-user-function/
      Handler: create-user.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # Not in VPC - can access Cognito directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
          COGNITO_USER_POOL_ID: !Ref CachaoUserPool
          USER_POOL_ID: !Ref CachaoUserPool
      Policies:
        - Statement:
            - Sid: CognitoUserManagement
              Effect: Allow
              Action:
                - cognito-idp:AdminCreateUser
                - cognito-idp:AdminGetUser
                - cognito-idp:ListUsers
              Resource: !GetAtt CachaoUserPool.Arn

  GenerateThumbnailFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - generate-thumbnail.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: generate-thumbnail/
      Handler: generate-thumbnail.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 300
      MemorySize: 3008
      # Removed VPC config - Lambda doesn't need VPC for S3 access
      # S3 access works via IAM roles without VPC
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
          S3_BUCKET_NAME: !Ref CachaoVideosBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref CachaoVideosBucket
        - S3WritePolicy:
            BucketName: !Ref CachaoVideosBucket
      Layers:
        - arn:aws:lambda:eu-west-1:109539191011:layer:ffmpeg:1
      Events:
        GenerateThumbnail:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/generate-thumbnail
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteAllVideosFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - app.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: delete-videos-function/
      Handler: app.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 30
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
      Events:
        DeleteAllVideos:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /admin/delete-all-videos
            Method: delete
            Auth:
              Authorizer: NONE

  EventsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - app.ts
        Target: "es2022"
        Format: "cjs"
    Properties:
      CodeUri: events-function/
      Handler: app.lambdaHandler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Timeout: 60
      MemorySize: 512
      # VPC removed - Lambda can access RDS directly via internet
      Environment:
        Variables:
          DB_HOST: cachao-mdb-2.cetzgm3nbskt.eu-west-1.rds.amazonaws.com
          DB_PORT: "3306"
          DB_NAME: cachao
          DB_USER: !Ref DatabaseUser
          DB_PASSWORD: !Ref DatabasePassword
          S3_BUCKET_NAME: !Ref CachaoVideosBucket
          USER_POOL_ID: !Ref CachaoUserPool
          COGNITO_USER_POOL_ID: !Ref CachaoUserPool
          THUMBNAIL_FUNCTION_NAME: !Ref GenerateThumbnailFunction
          CREATE_USER_FUNCTION_NAME: !Ref CreateUserFunction
          AVIATIONSTACK_API_KEY: !Ref AviationStackApiKey
      Policies:
        - S3WritePolicy:
            BucketName: !Ref CachaoVideosBucket
        - S3ReadPolicy:
            BucketName: !Ref CachaoVideosBucket
        - LambdaInvokePolicy:
            FunctionName: !Ref GenerateThumbnailFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CreateUserFunction
      Events:
        GetEvents:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events
            Method: get
            Auth:
              Authorizer: NONE
        CreateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        GenerateEventImageUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/image-upload-url
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        GetEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}
            Method: get
            Auth:
              Authorizer: NONE
        UpdateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}
            Method: patch
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteEvent:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
        GetEventVideos:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/videos
            Method: get
            Auth:
              Authorizer: NONE
        GetEventAlbums:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/albums
            Method: get
            Auth:
              Authorizer: NONE
        CreateEventAlbum:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/albums
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        GetEventStaff:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/staff
            Method: get
            Auth:
              Authorizer: NONE
        AddEventStaff:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/staff
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteEventStaff:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/staff/{staffId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
        GetEventFlights:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/flights
            Method: get
            Auth:
              Authorizer: NONE
        AddEventFlight:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/flights
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteEventFlight:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /events/{id}/flights/{flightId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
        UploadVideos:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        GeneratePresignedUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/upload-url
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        ConfirmVideoUpload:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/confirm
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        DeleteVideos:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateVideoCategory:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/{id}
            Method: patch
            Auth:
              Authorizer: CognitoAuthorizer
        GetUserProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /user/profile
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateUserProfile:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /user/profile
            Method: patch
            Auth:
              Authorizer: CognitoAuthorizer
        GenerateProfilePhotoUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /user/profile-photo-upload-url
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        GetUserEvents:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /user/events
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        GetUserVideos:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /user/videos
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        InitiateMultipartUpload:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/multipart/init
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        CompleteMultipartUpload:
          Type: Api
          Properties:
            RestApiId: !Ref CachaoApi
            Path: /videos/multipart/complete
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

Parameters:
  DatabaseUser:
    Type: String
    Description: Database username
    NoEcho: false
  DatabasePassword:
    Type: String
    Description: Database password
    NoEcho: true
  AviationStackApiKey:
    Type: String
    Description: AviationStack API key for flight lookups (optional)
    Default: ""
    NoEcho: true

Outputs:
  CachaoApi:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${CachaoApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/Prod/"
  HelloWorldApi:
    Description: "API Gateway endpoint URL for Hello World function"
    Value: !Sub "https://${CachaoApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/Prod/hello/"
  EventsApi:
    Description: "API Gateway endpoint URL for Events function"
    Value: !Sub "https://${CachaoApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/Prod/events/"
  VideosApi:
    Description: "API Gateway endpoint URL for Video upload function"
    Value: !Sub "https://${CachaoApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/Prod/videos/"
  VideosBucket:
    Description: "S3 Bucket for storing video files"
    Value: !Ref CachaoVideosBucket
  HelloWorldFunction:
    Description: "Hello World Lambda Function ARN"
    Value: !GetAtt HelloWorldFunction.Arn
  EventsFunction:
    Description: "Events Lambda Function ARN"
    Value: !GetAtt EventsFunction.Arn
  HelloWorldFunctionIamRole:
    Description: "Implicit IAM Role created for Hello World function"
    Value: !GetAtt HelloWorldFunctionRole.Arn
  EventsFunctionIamRole:
    Description: "Implicit IAM Role created for Events function"
    Value: !GetAtt EventsFunctionRole.Arn
  UserPoolId:
    Description: "Cognito User Pool ID"
    Value: !Ref CachaoUserPool
  UserPoolClientId:
    Description: "Cognito User Pool Client ID"
    Value: !Ref CachaoUserPoolClient
